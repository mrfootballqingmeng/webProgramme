<!DOCTYPE html>
<html>
<head>
  <title>NTU NEST - My Follows</title>
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
<div class="container">
  <!-- 左栏 -->
  <div class="sidebar-left">
    <div class="logo-section">
      <img src="/images/logo.jpg" class="nav-logo">
      <h2>NTU NEST</h2>
    </div>
    <ul class="nav">
      <li><a href="/home"><i class="fa fa-home"></i> Home</a></li>
      <li><a href="/topics"><i class="fa fa-hashtag"></i> Topics</a></li>
      <li><a href="/my-follows"><i class="fa fa-user-check"></i> My Follow</a></li>
      <li><a href="/notifications"><i class="fa fa-bell"></i> Notifications</a></li>
      <li><a href="/messages"><i class="fa fa-envelope"></i> Messages</a></li>
      <li><a href="/profile"><i class="fa fa-user"></i> Profile</a></li>
    </ul>
  </div>

  <!-- 中栏 -->
  <div class="main follows-page" style="background-image:none;">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;">
      <h3 class="section-title" style="margin:0;">我关注的人 <span id="follow-count" style="color:#6b7280;font-size:14px;">(<%= (follows||[]).length %>)</span></h3>
      <div class="follows-toolbar" style="display:flex;gap:8px;align-items:center;">
        <input id="f-search" placeholder="搜索昵称/用户名/简介..." style="padding:8px 10px;border:1px solid #e5e7eb;border-radius:8px;min-width:220px;">
        <select id="f-sort" style="padding:8px 10px;border:1px solid #e5e7eb;border-radius:8px;">
          <option value="recent">最近关注</option>
          <option value="name">按名称 A-Z</option>
        </select>
      </div>
    </div>

    <div class="follows-list" id="f-list">
      <% if (follows && follows.length > 0) { %>
        <% follows.forEach(u => { %>
          <div class="follow-card" data-id="<%= u.id %>" data-name="<%= (u.display_name||u.username||'').toLowerCase() %>" data-user="<%= (u.username||'').toLowerCase() %>" data-bio="<%= (u.bio||'').toLowerCase() %>">
            <img class="follow-avatar" src="<%= u.avatar || '/images/logo.jpg' %>" onerror="this.onerror=null;this.src='/images/logo.jpg'"/>
            <div class="follow-info">
              <div class="follow-name"><%= u.display_name || u.username %></div>
              <div class="follow-username">@<%= u.username %></div>
              <% if (u.bio) { %><div class="follow-bio"><%= u.bio %></div><% } %>
            </div>
            <div class="follow-actions">
              <button class="btn-secondary user-link" data-user-id="<%= u.id %>">查看</button>
              <button class="btn-danger btn-unfollow" data-user-id="<%= u.id %>">取消关注</button>
            </div>
          </div>
        <% }) %>
      <% } else { %>
        <div class="no-posts"><p>你还没有关注任何人</p></div>
      <% } %>
    </div>
  </div>

  <!-- 右栏 -->
  <div class="sidebar-right">
    <div class="info-card">
      <h3>Tips</h3>
      <p>点击“查看”可打开该用户卡片并进行取关。</p>
    </div>
  </div>
</div>
<script src="/js/main.js"></script>
<script>
// 中文注释：本页增强交互（搜索/排序/取消关注）
(function(){
  const listEl = document.getElementById('f-list');
  const searchEl = document.getElementById('f-search');
  const sortEl = document.getElementById('f-sort');
  const countEl = document.getElementById('follow-count');

  function applyFilterSort(){
    const kw = (searchEl.value||'').trim().toLowerCase();
    const items = Array.from(listEl.querySelectorAll('.follow-card'));
    let visible = 0;
    items.forEach(card => {
      const name = card.getAttribute('data-name');
      const user = card.getAttribute('data-user');
      const bio  = card.getAttribute('data-bio');
      const match = !kw || (name.includes(kw) || user.includes(kw) || bio.includes(kw));
      card.style.display = match ? 'flex' : 'none';
      if (match) visible++;
    });

    // 排序（仅调整可见项的顺序）
    const mode = sortEl.value;
    const visibleCards = items.filter(c => c.style.display !== 'none');
    visibleCards.sort((a,b)=>{
      if (mode === 'name'){
        return a.getAttribute('data-name').localeCompare(b.getAttribute('data-name'));
      }
      // recent: 以原顺序为最近（不变）
      return 0;
    }).forEach(c => listEl.appendChild(c));

    if (countEl) countEl.textContent = '('+visible+')';
  }
  if (searchEl) searchEl.addEventListener('input', applyFilterSort);
  if (sortEl) sortEl.addEventListener('change', applyFilterSort);

  // 取消关注
  listEl.addEventListener('click', async (e)=>{
    const btn = e.target.closest('.btn-unfollow');
    if (!btn) return;
    const uid = btn.getAttribute('data-user-id');
    if (!uid) return;
    if (!confirm('确定要取消关注该用户吗？')) return;
    try{
      const res = await fetch('/api/users/'+uid+'/follow', { method:'DELETE' });
      if (!res.ok){ const j = await res.json().catch(()=>({})); throw new Error(j.error||'取消关注失败'); }
      const card = listEl.querySelector('.follow-card[data-id="'+uid+'"]');
      if (card){ card.style.opacity='0'; setTimeout(()=>{ card.remove(); applyFilterSort(); }, 180); }
      alert('已取消关注');
    }catch(err){ alert(err.message||'操作失败'); }
  });

  applyFilterSort();
})();
</script>
<!-- 复用用户卡片浮层 -->
<div id="user-card" class="user-card">
  <div class="user-card-header">
    <img id="uc-avatar" class="user-card-avatar" src="/images/logo.jpg" alt="avatar" />
    <div>
      <div id="uc-display" class="user-card-name">用户名</div>
      <div id="uc-username" class="user-card-username">@username</div>
    </div>
  </div>
  <div id="uc-bio" class="user-card-bio"></div>
  <div class="user-card-stats">
    <div><span id="uc-followers">0</span> 粉丝</div>
    <div><span id="uc-following">0</span> 关注</div>
  </div>
  <div class="user-card-actions">
    <button id="uc-follow-btn" class="btn-follow">关注</button>
  </div>
 </div>
</body>
</html>
