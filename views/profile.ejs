<!DOCTYPE html>
<html>
<head>
  <title>Profile - <%= profile.username %></title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
  <div class="profile-container">
    <a href="/home" class="profile-back">&larr; è¿”å›é¦–é¡µ</a>
    <h2 class="profile-title">ç”¨æˆ·èµ„æ–™</h2>
    <div class="profile-header">
      <div class="profile-avatar-wrapper">
        <img class="profile-avatar" src="<%= profile.avatar || '/images/logo.jpg' %>" onerror="this.onerror=null;this.src='/images/logo.jpg'" alt="avatar" />
      </div>
      <div class="profile-info">
        <p><strong>ç”¨æˆ·å:</strong> <%= profile.username %></p>
        <p><strong>æ˜¾ç¤ºåç§°:</strong> <%= profile.display_name || '-' %></p>
        <p><strong>ç®€ä»‹:</strong> <%= profile.bio || '-' %></p>
        <p><strong>åŠ å…¥æ—¶é—´:</strong> <%= profile.created_at ? new Date(profile.created_at).toLocaleDateString() : '-' %></p>
      </div>
    </div>

    <!-- ç”¨æˆ·å‘å¸–å†å² -->
    <div class="profile-posts-section">
      <h3 class="profile-edit-title">æˆ‘çš„å‘å¸–å†å²</h3>
      <div id="user-posts-container" class="user-posts-feed">
        <div class="loading-message">åŠ è½½ä¸­...</div>
      </div>
    </div>

    <% if (user && user.id === profile.id) { %>
    <div class="profile-edit-section">
      <h3 class="profile-edit-title">ç¼–è¾‘èµ„æ–™</h3>
      <form action="/profile" method="POST" enctype="multipart/form-data" class="profile-form">
        <input type="text" name="username" placeholder="æ–°çš„ç”¨æˆ·å (ç•™ç©ºä¸æ”¹)">
        <input type="text" name="display_name" placeholder="æ˜¾ç¤ºåç§° (ç•™ç©ºä¸æ”¹)">
        <textarea name="bio" placeholder="ä¸ªäººç®€ä»‹ (ç•™ç©ºä¸æ”¹)" rows="3"></textarea>
        <label class="file-input-wrapper">å¤´åƒ:
          <input type="file" name="avatar" accept="image/*">
        </label>
        <button type="submit" class="btn-primary">ä¿å­˜ä¿®æ”¹</button>
      </form>
    </div>
    <div class="profile-edit-section">
      <h3 class="profile-edit-title">ä¿®æ”¹å¯†ç </h3>
      <form action="/profile/change-password" method="POST" class="profile-form">
        <input type="password" name="old_password" placeholder="åŸå¯†ç  (é¦–æ¬¡è®¾ç½®å¯ç•™ç©º)" autocomplete="current-password">
        <input type="password" name="new_password" placeholder="æ–°å¯†ç  (è‡³å°‘6ä½)" required autocomplete="new-password">
        <input type="password" name="confirm_password" placeholder="ç¡®è®¤æ–°å¯†ç " required autocomplete="new-password">
        <button type="submit" class="btn-primary">æ›´æ–°å¯†ç </button>
      </form>
    </div>
    <div class="profile-edit-section">
      <h3 class="profile-edit-title">è´¦æˆ·æ“ä½œ</h3>
      <div class="profile-form">
        <a href="/logout" class="btn-logout" onclick="return confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')">
          <i class="fas fa-sign-out-alt"></i> é€€å‡ºç™»å½•
        </a>
      </div>
    </div>
    <% } %>
  </div>
  
  <script src="/js/main.js"></script>
  <script>
    // Load user posts when page loads
    document.addEventListener('DOMContentLoaded', function() {
      loadUserPosts();
    });
    
    async function loadUserPosts() {
      const container = document.getElementById('user-posts-container');
      try {
        const response = await fetch('/api/user/posts');
        const data = await response.json();
        
        if (response.ok && data.posts && data.posts.length > 0) {
          container.innerHTML = '';
          data.posts.forEach(post => {
            const postElement = createPostElement(post);
            container.appendChild(postElement);
          });
          // Bind delete functionality
          bindUserPostsInteractions();
        } else {
          container.innerHTML = '<div class="no-posts"><p>è¿˜æ²¡æœ‰å‘å¸ƒè¿‡å¸–å­</p></div>';
        }
      } catch (error) {
        console.error('Error loading user posts:', error);
        container.innerHTML = '<div class="error-message">åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•</div>';
      }
    }
    
    function createPostElement(post) {
      const postDiv = document.createElement('div');
      postDiv.className = 'user-post-card';
      postDiv.setAttribute('data-post-id', post.id);
      
      let filesHtml = '';
      if (post.files && post.files.length > 0) {
        filesHtml = '<div class="post-images" style="display:flex;gap:6px;flex-wrap:wrap;margin-top:8px;">';
        post.files.forEach(file => {
          filesHtml += `<img src="${file}" style="max-width:120px;max-height:120px;object-fit:cover;border-radius:6px;" onerror="this.onerror=null;this.src='/images/logo.jpg'" />`;
        });
        filesHtml += '</div>';
      }
      
      postDiv.innerHTML = `
        <div class="post-header">
          <span class="post-topic">å‘å¸ƒäº ${post.topic_name || 'æœªçŸ¥è¯é¢˜'}</span>
          <span class="post-time">${new Date(post.createdAt).toLocaleDateString()}</span>
        </div>
        <div class="post-content">
          <p>${post.content || ''}</p>
          ${filesHtml}
        </div>
        <div class="post-stats">
          <span>â¤ï¸ ${post.likes || 0}</span>
          <span>ğŸ’¬ ${post.comments || 0}</span>
          <span>â†—ï¸ ${post.shares || 0}</span>
          <button class="btn-delete-user-post" data-post-id="${post.id}">ğŸ—‘ï¸ åˆ é™¤</button>
        </div>
      `;
      
      return postDiv;
    }
    
    function bindUserPostsInteractions() {
      document.querySelectorAll('.btn-delete-user-post').forEach(btn => {
        if (btn._bound) return;
        btn._bound = true;
        btn.addEventListener('click', async () => {
          const postId = btn.getAttribute('data-post-id');
          if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå¸–å­å—ï¼Ÿåˆ é™¤åæ— æ³•æ¢å¤ã€‚')) return;
          
          try {
            const response = await fetch(`/api/posts/${postId}`, { method: 'DELETE' });
            const data = await response.json();
            
            if (response.ok) {
              const postCard = btn.closest('.user-post-card');
              if (postCard) {
                postCard.style.transition = 'opacity 0.3s ease';
                postCard.style.opacity = '0';
                setTimeout(() => postCard.remove(), 300);
              }
              alert('å¸–å­å·²åˆ é™¤');
            } else {
              alert(data.error || 'åˆ é™¤å¤±è´¥');
            }
          } catch (error) {
            console.error('Delete error:', error);
            alert('åˆ é™¤å¤±è´¥');
          }
        });
      });
    }
  </script>
</body>
</html>
