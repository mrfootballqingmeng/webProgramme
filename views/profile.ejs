<!DOCTYPE html>
<html lang="en">
<head>
  <title>Profile - <%= profile.username %></title>
  <link rel="stylesheet" href="/css/style.css">
  <!-- ÂõæÊ†áÂ∫ì -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
<div class="container">

  <!-- Â∑¶Ê†è -->
  <div class="sidebar-left">
    <div class="logo-section">
      <img src="/images/logo.jpg" class="nav-logo">
      <h2>NTU NEST</h2>
    </div>
    <ul class="nav">
      <li><a href="/home"><i class="fa fa-home"></i> Home</a></li>
      <li><a href="/topics"><i class="fa fa-hashtag"></i> Topics</a></li>
      <li><a href="/my-follows"><i class="fa fa-user-check"></i> My Follow</a></li>
      <li><a href="/explore"><i class="fa fa-magnifying-glass"></i> Explore</a></li>
      <li><a href="/notifications"><i class="fa fa-bell"></i> Notifications</a></li>
      <li><a href="/messages"><i class="fa fa-envelope"></i> Messages</a></li>
      <li class="active"><i class="fa fa-user"></i> Profile</li>
      <li><a href="/history"><i class="fa fa-clock-rotate-left"></i> History</a></li>
    </ul>
  </div>

  <!-- ‰∏≠Ê†è -->
  <div class="main">
  <h3 class="section-title">User Profile</h3>
    <div class="profile-header">
      <div class="profile-avatar-wrapper">
        <img class="profile-avatar" src="<%= profile.avatar || '/images/logo.jpg' %>" onerror="this.onerror=null;this.src='/images/logo.jpg'" alt="avatar" />
      </div>
      <div class="profile-info">
  <p><strong>Username:</strong> <%= profile.username %></p>
  <p><strong>Display name:</strong> <%= profile.display_name || '-' %></p>
  <p><strong>Bio:</strong> <%= profile.bio || '-' %></p>
  <p><strong>Joined:</strong> <%= profile.created_at ? new Date(profile.created_at).toLocaleDateString() : '-' %></p>
      </div>
    </div>

    <!-- Áî®Êà∑ÂèëÂ∏ñÂéÜÂè≤ -->
    <div class="profile-posts-section">
      <h3 class="profile-edit-title">My posts</h3>
      <div id="user-posts-container" class="user-posts-feed">
        <div class="loading-message">Loading...</div>
      </div>
    </div>

    <% if (user && user.id === profile.id) { %>
    <div class="profile-edit-section">
  <h3 class="profile-edit-title">Edit profile</h3>
      <form action="/profile" method="POST" enctype="multipart/form-data" class="profile-form">
        <input type="text" name="username" placeholder="New username (leave blank to keep)">
        <input type="text" name="display_name" placeholder="Display name (leave blank to keep)">
        <textarea name="bio" placeholder="Bio (leave blank to keep)" rows="3"></textarea>
        <label class="file-input-wrapper">Avatar:
          <input type="file" name="avatar" accept="image/*">
        </label>
        <button type="submit" class="btn-primary">Save changes</button>
      </form>
    </div>
    <div class="profile-edit-section">
      <h3 class="profile-edit-title">Change password</h3>
      <form action="/profile/change-password" method="POST" class="profile-form">
        <input type="password" name="old_password" placeholder="Old password (leave empty if not set)" autocomplete="current-password">
        <input type="password" name="new_password" placeholder="New password (min 6 chars)" required autocomplete="new-password">
        <input type="password" name="confirm_password" placeholder="Confirm new password" required autocomplete="new-password">
        <button type="submit" class="btn-primary">Update password</button>
      </form>
    </div>
    <div class="profile-edit-section">
      <h3 class="profile-edit-title">Account actions</h3>
      <div class="profile-form">
        <a href="/logout" class="btn-logout" onclick="return confirm('Are you sure you want to log out?')">
          <i class="fas fa-sign-out-alt"></i> Log out
        </a>
      </div>
    </div>
    <% } %>
  </div>

  <!-- Âè≥Ê†è -->
  <div class="sidebar-right">
    <div class="info-card">
      <h3>Profile tips</h3>
      <ul>
        <li>Complete your profile to increase credibility</li>
        <li>Upload an avatar so others can recognize you</li>
        <li>Update your bio regularly</li>
      </ul>
    </div>
    <div class="info-card">
      <h3>Today's Weather</h3>
      <div id="weather">Loading...</div>
    </div>
    <div class="info-card">
      <h3>Quick Links</h3>
      <a href="https://ntulearn.ntu.edu.sg/" target="_blank" class="quick-link">NTULearn</a>
      <a href="https://sso.wis.ntu.edu.sg/" target="_blank" class="quick-link">GSlink</a>
    </div>
  </div>

</div>

<script src="/js/main.js"></script>
<script>
  // Load user posts when page loads
  document.addEventListener('DOMContentLoaded', function() {
    loadUserPosts();
  });
  
  async function loadUserPosts() {
    const container = document.getElementById('user-posts-container');
    try {
      const response = await fetch('/api/user/posts');
      const data = await response.json();
      
      if (response.ok && data.posts && data.posts.length > 0) {
        container.innerHTML = '';
        data.posts.forEach(post => {
          const postElement = createPostElement(post);
          container.appendChild(postElement);
        });
        // Bind delete functionality
        bindUserPostsInteractions();
        } else {
        container.innerHTML = '<div class="no-posts"><p>No posts yet</p></div>';
      }
    } catch (error) {
      console.error('Error loading user posts:', error);
  container.innerHTML = '<div class="error-message">Failed to load. Please refresh and try again.</div>';
    }
  }
  
  function createPostElement(post) {
    const postDiv = document.createElement('div');
    postDiv.className = 'user-post-card';
    postDiv.setAttribute('data-post-id', post.id);
    
    let filesHtml = '';
    if (post.files && post.files.length > 0) {
      filesHtml = '<div class="post-images" style="display:flex;gap:6px;flex-wrap:wrap;margin-top:8px;">';
      post.files.forEach(file => {
        filesHtml += `<img src="${file}" style="max-width:120px;max-height:120px;object-fit:cover;border-radius:6px;" onerror="this.onerror=null;this.src='/images/logo.jpg'" />`;
      });
      filesHtml += '</div>';
    }
    
        postDiv.innerHTML = `
      <div class="post-header">
        <span class="post-topic">Posted in ${post.topic_name || 'Unknown topic'}</span>
        <span class="post-time">${new Date(post.createdAt).toLocaleDateString()}</span>
      </div>
      <div class="post-content">
        <p>${post.content || ''}</p>
        ${filesHtml}
      </div>
      <div class="post-stats">
        <span>‚ù§Ô∏è ${post.likes || 0}</span>
        <span>üí¨ ${post.comments || 0}</span>
        <span>‚ÜóÔ∏è ${post.shares || 0}</span>
        <button class="btn-delete-user-post" data-post-id="${post.id}">üóëÔ∏è Delete</button>
      </div>
    `;
    
    return postDiv;
  }
  
  function bindUserPostsInteractions() {
    document.querySelectorAll('.btn-delete-user-post').forEach(btn => {
      if (btn._bound) return;
      btn._bound = true;
      btn.addEventListener('click', async () => {
        const postId = btn.getAttribute('data-post-id');
  if (!confirm('Are you sure you want to delete this post? This action cannot be undone.')) return;
        
        try {
          const response = await fetch(`/api/posts/${postId}`, { method: 'DELETE' });
          const data = await response.json();
          
          if (response.ok) {
            const postCard = btn.closest('.user-post-card');
            if (postCard) {
              postCard.style.transition = 'opacity 0.3s ease';
              postCard.style.opacity = '0';
              setTimeout(() => postCard.remove(), 300);
            }
            alert('Post deleted');
          } else {
            alert(data.error || 'Failed to delete');
          }
        } catch (error) {
          console.error('Delete error:', error);
          alert('Failed to delete');
        }
      });
    });
  }
</script>
</body>
</html>
