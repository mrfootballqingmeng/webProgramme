<!DOCTYPE html>
<html>
<head>
  <title>Profile - <%= profile.username %></title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
  <div class="profile-container">
    <a href="/home" class="profile-back">&larr; 返回首页</a>
    <h2 class="profile-title">用户资料</h2>
    <div class="profile-header">
      <div class="profile-avatar-wrapper">
        <img class="profile-avatar" src="<%= profile.avatar || '/images/logo.jpg' %>" onerror="this.onerror=null;this.src='/images/logo.jpg'" alt="avatar" />
      </div>
      <div class="profile-info">
        <p><strong>用户名:</strong> <%= profile.username %></p>
        <p><strong>显示名称:</strong> <%= profile.display_name || '-' %></p>
        <p><strong>简介:</strong> <%= profile.bio || '-' %></p>
        <p><strong>加入时间:</strong> <%= profile.created_at ? new Date(profile.created_at).toLocaleDateString() : '-' %></p>
      </div>
    </div>

    <!-- 用户发帖历史 -->
    <div class="profile-posts-section">
      <h3 class="profile-edit-title">我的发帖历史</h3>
      <div id="user-posts-container" class="user-posts-feed">
        <div class="loading-message">加载中...</div>
      </div>
    </div>

    <% if (user && user.id === profile.id) { %>
    <div class="profile-edit-section">
      <h3 class="profile-edit-title">编辑资料</h3>
      <form action="/profile" method="POST" enctype="multipart/form-data" class="profile-form">
        <input type="text" name="username" placeholder="新的用户名 (留空不改)">
        <input type="text" name="display_name" placeholder="显示名称 (留空不改)">
        <textarea name="bio" placeholder="个人简介 (留空不改)" rows="3"></textarea>
        <label class="file-input-wrapper">头像:
          <input type="file" name="avatar" accept="image/*">
        </label>
        <button type="submit" class="btn-primary">保存修改</button>
      </form>
    </div>
    <div class="profile-edit-section">
      <h3 class="profile-edit-title">修改密码</h3>
      <form action="/profile/change-password" method="POST" class="profile-form">
        <input type="password" name="old_password" placeholder="原密码 (首次设置可留空)" autocomplete="current-password">
        <input type="password" name="new_password" placeholder="新密码 (至少6位)" required autocomplete="new-password">
        <input type="password" name="confirm_password" placeholder="确认新密码" required autocomplete="new-password">
        <button type="submit" class="btn-primary">更新密码</button>
      </form>
    </div>
    <div class="profile-edit-section">
      <h3 class="profile-edit-title">账户操作</h3>
      <div class="profile-form">
        <a href="/logout" class="btn-logout" onclick="return confirm('确定要退出登录吗？')">
          <i class="fas fa-sign-out-alt"></i> 退出登录
        </a>
      </div>
    </div>
    <% } %>
  </div>
  
  <script src="/js/main.js"></script>
  <script>
    // Load user posts when page loads
    document.addEventListener('DOMContentLoaded', function() {
      loadUserPosts();
    });
    
    async function loadUserPosts() {
      const container = document.getElementById('user-posts-container');
      try {
        const response = await fetch('/api/user/posts');
        const data = await response.json();
        
        if (response.ok && data.posts && data.posts.length > 0) {
          container.innerHTML = '';
          data.posts.forEach(post => {
            const postElement = createPostElement(post);
            container.appendChild(postElement);
          });
          // Bind delete functionality
          bindUserPostsInteractions();
        } else {
          container.innerHTML = '<div class="no-posts"><p>还没有发布过帖子</p></div>';
        }
      } catch (error) {
        console.error('Error loading user posts:', error);
        container.innerHTML = '<div class="error-message">加载失败，请刷新页面重试</div>';
      }
    }
    
    function createPostElement(post) {
      const postDiv = document.createElement('div');
      postDiv.className = 'user-post-card';
      postDiv.setAttribute('data-post-id', post.id);
      
      let filesHtml = '';
      if (post.files && post.files.length > 0) {
        filesHtml = '<div class="post-images" style="display:flex;gap:6px;flex-wrap:wrap;margin-top:8px;">';
        post.files.forEach(file => {
          filesHtml += `<img src="${file}" style="max-width:120px;max-height:120px;object-fit:cover;border-radius:6px;" onerror="this.onerror=null;this.src='/images/logo.jpg'" />`;
        });
        filesHtml += '</div>';
      }
      
      postDiv.innerHTML = `
        <div class="post-header">
          <span class="post-topic">发布于 ${post.topic_name || '未知话题'}</span>
          <span class="post-time">${new Date(post.createdAt).toLocaleDateString()}</span>
        </div>
        <div class="post-content">
          <p>${post.content || ''}</p>
          ${filesHtml}
        </div>
        <div class="post-stats">
          <span>❤️ ${post.likes || 0}</span>
          <span>💬 ${post.comments || 0}</span>
          <span>↗️ ${post.shares || 0}</span>
          <button class="btn-delete-user-post" data-post-id="${post.id}">🗑️ 删除</button>
        </div>
      `;
      
      return postDiv;
    }
    
    function bindUserPostsInteractions() {
      document.querySelectorAll('.btn-delete-user-post').forEach(btn => {
        if (btn._bound) return;
        btn._bound = true;
        btn.addEventListener('click', async () => {
          const postId = btn.getAttribute('data-post-id');
          if (!confirm('确定要删除这个帖子吗？删除后无法恢复。')) return;
          
          try {
            const response = await fetch(`/api/posts/${postId}`, { method: 'DELETE' });
            const data = await response.json();
            
            if (response.ok) {
              const postCard = btn.closest('.user-post-card');
              if (postCard) {
                postCard.style.transition = 'opacity 0.3s ease';
                postCard.style.opacity = '0';
                setTimeout(() => postCard.remove(), 300);
              }
              alert('帖子已删除');
            } else {
              alert(data.error || '删除失败');
            }
          } catch (error) {
            console.error('Delete error:', error);
            alert('删除失败');
          }
        });
      });
    }
  </script>
</body>
</html>
